// Prisma Schema for Keyword-Ninja
// Database: PostgreSQL (Railway)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION MODELS (NextAuth.js)
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  role          String    @default("pending") // "superadmin", "admin", "user", "pending"
  isActive      Boolean   @default(true)
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  
  // CMS Relations
  createdPages   CmsPage[]        @relation("CmsPageCreator")
  reviewedPages  CmsPage[]        @relation("CmsPageReviewer")
  pageVersions   CmsPageVersion[] @relation("CmsVersionCreator")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// CLIENT MASTER (Unified - replaces JSON file)
// ============================================

model Client {
  id          String   @id @default(cuid())
  code        String   @unique  // e.g., "01", "02" - used as foreign key everywhere
  name        String
  mainDomain  String?
  domains     Json     @default("[]") // Array of domain strings
  notes       String?  @db.Text
  industry    String?
  isActive    Boolean  @default(true)
  
  // Business Metrics (conversion funnel)
  businessMetrics Json? // {ctrTop5, ctrTop10, visitToRfq, rfqToOrder, avgTicketSize}
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // CMS Relations
  cmsConfig     CmsClientConfig?
  cmsTopics     CmsTopic[]
  cmsPages      CmsPage[]
  cmsTemplates  CmsClientTemplate[]
  cmsAssets     CmsAsset[]
  cmsClusters   CmsCluster[]
  cmsSitemap    CmsSitemap?
}

// ============================================
// CMS MODELS - Content Management System
// ============================================

// --- CLIENT CMS CONFIG ---

model CmsClientConfig {
  id                String  @id @default(cuid())
  clientCode        String  @unique
  
  // CMS Slug for /feed/{slug}/
  slug              String  @unique
  logo              String?
  
  // Cloudflare Settings
  cfApiToken        String?  // Encrypted
  cfZoneId          String?
  cfAccountId       String?
  
  // SEO Settings
  defaultOgImage    String?
  robotsTxt         String?  @db.Text // Custom robots.txt content
  gaTrackingId      String?
  gscPropertyUrl    String?
  
  // Publishing Settings
  autoPublish       Boolean @default(false)
  requireReview     Boolean @default(true)
  
  // API Keys for Content
  openaiApiKey      String?  // Encrypted
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  client            Client @relation(fields: [clientCode], references: [code], onDelete: Cascade)
}

// --- TOPIC & CLUSTER MANAGEMENT ---

model CmsCluster {
  id          String   @id @default(cuid())
  clientCode  String
  name        String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  
  client      Client   @relation(fields: [clientCode], references: [code], onDelete: Cascade)
  topics      CmsTopic[]
  
  @@unique([clientCode, name])
  @@index([clientCode])
}

model CmsTopic {
  id              String   @id @default(cuid())
  clientCode      String
  clusterId       String?
  
  // Topic Data
  name            String
  slug            String
  primaryKeyword  String
  keywords        Json     // Array of related keywords with volumes
  searchVolume    Int      @default(0)
  intentType      String?  // informational, transactional, navigational, commercial
  intentScore     Float?
  
  // Status
  status          String   @default("pending") // pending, in_progress, completed, skipped
  priority        Int      @default(0)
  
  // Metadata
  sourceData      Json?    // Original data from Intent Analysis
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  client          Client     @relation(fields: [clientCode], references: [code], onDelete: Cascade)
  cluster         CmsCluster? @relation(fields: [clusterId], references: [id])
  page            CmsPage?
  
  @@unique([clientCode, slug])
  @@index([clientCode, status])
}

// --- PAGE MANAGEMENT ---

model CmsPage {
  id              String   @id @default(cuid())
  clientCode      String
  topicId         String?  @unique
  templateId      String
  
  // Page Content
  title           String
  slug            String
  metaDescription String?  @db.Text
  metaKeywords    String?
  canonicalUrl    String?
  
  // Content Sections (JSON for flexibility)
  content         Json     // {hero: {...}, body: {...}, faq: [...], etc.}
  
  // SEO Data
  structuredData  Json?    // JSON-LD schema
  ogTitle         String?
  ogDescription   String?  @db.Text
  ogImage         String?
  
  // Publishing Status
  status          String   @default("draft") // draft, review, scheduled, published, archived
  publishedAt     DateTime?
  scheduledAt     DateTime?
  archivedAt      DateTime?
  
  // Internal Linking
  internalLinks   Json?    // Array of {text, url, anchor}
  
  // Analytics
  views           Int      @default(0)
  
  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdById     String?
  reviewedById    String?
  
  // Relations
  client          Client          @relation(fields: [clientCode], references: [code], onDelete: Cascade)
  topic           CmsTopic?       @relation(fields: [topicId], references: [id])
  template        CmsTemplate     @relation(fields: [templateId], references: [id])
  versions        CmsPageVersion[]
  assets          CmsPageAsset[]
  createdBy       User?           @relation("CmsPageCreator", fields: [createdById], references: [id])
  reviewedBy      User?           @relation("CmsPageReviewer", fields: [reviewedById], references: [id])
  
  @@unique([clientCode, slug])
  @@index([clientCode, status])
  @@index([status, scheduledAt])
}

model CmsPageVersion {
  id          String   @id @default(cuid())
  pageId      String
  version     Int
  
  // Snapshot
  title       String
  content     Json
  
  // Metadata
  changeNote  String?
  createdAt   DateTime @default(now())
  createdById String?
  
  // Relations
  page        CmsPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdBy   User?    @relation("CmsVersionCreator", fields: [createdById], references: [id])
  
  @@unique([pageId, version])
}

// --- TEMPLATE SYSTEM ---

model CmsTemplate {
  id          String   @id @default(cuid())
  
  // Template Info
  name        String
  slug        String   @unique
  description String?  @db.Text
  type        String   // blog, ecommerce, landing, comparison, glossary
  thumbnail   String?
  
  // Template Structure
  sections    Json     // Array of section definitions
  styles      Json?    // CSS variables, theme settings
  
  // Status
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false) // System templates can't be deleted
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  pages       CmsPage[]
  clients     CmsClientTemplate[]
}

model CmsClientTemplate {
  id          String   @id @default(cuid())
  clientCode  String
  templateId  String
  
  // Client-specific overrides
  customStyles Json?
  isDefault    Boolean @default(false)
  
  client      Client      @relation(fields: [clientCode], references: [code], onDelete: Cascade)
  template    CmsTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@unique([clientCode, templateId])
}

// --- ASSET MANAGEMENT ---

model CmsAsset {
  id          String   @id @default(cuid())
  clientCode  String
  
  // Asset Info
  name        String
  filename    String
  mimeType    String
  size        Int
  url         String   // Can be local path or R2 URL
  
  // Source
  source      String   @default("upload") // upload, ai_generated, stock, client_website
  sourceUrl   String?  // Original URL if scraped
  
  // Metadata
  alt         String?
  caption     String?
  
  createdAt   DateTime @default(now())
  
  // Relations
  client      Client       @relation(fields: [clientCode], references: [code], onDelete: Cascade)
  pages       CmsPageAsset[]
}

model CmsPageAsset {
  id        String @id @default(cuid())
  pageId    String
  assetId   String
  
  // Usage context
  section   String?  // Which section uses this asset
  order     Int      @default(0)
  
  page      CmsPage  @relation(fields: [pageId], references: [id], onDelete: Cascade)
  asset     CmsAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  @@unique([pageId, assetId])
}

// --- PUBLISHING & JOBS ---

model CmsPublishJob {
  id          String   @id @default(cuid())
  clientCode  String
  pageId      String?
  
  // Job Info
  type        String   // single_page, batch, sitemap, indexnow
  status      String   @default("pending") // pending, running, completed, failed
  
  // Results
  result      Json?
  error       String?  @db.Text
  
  // Timing
  createdAt   DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  
  @@index([clientCode])
  @@index([status])
}

model CmsSitemap {
  id          String   @id @default(cuid())
  clientCode  String   @unique
  
  // Sitemap content (regenerated on publish)
  content     String   @db.Text
  lastBuilt   DateTime @default(now())
  pageCount   Int      @default(0)
  
  client      Client   @relation(fields: [clientCode], references: [code], onDelete: Cascade)
}

// ============================================
// DIGITAL FOOTPRINT - Presence Audit
// ============================================

model FootprintScan {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  domainsRaw      String   @db.Text
  hintsRaw        String?  @db.Text
  settingsJson    Json?
  totalDomains    Int
  finishedDomains Int      @default(0)
  status          String   @default("pending") // pending, running, completed, failed
  
  domainScans     DomainScan[]
  
  @@index([status])
}

model DomainScan {
  id                String   @id @default(cuid())
  scanId            String
  domainRaw         String
  domainNormalized  String
  crawlStatus       String?  // success, failed, skipped
  finalUrl          String?
  httpStatus        Int?
  crawlDataJson     Json?    // Extracted entity data from crawl
  profileJson       Json?    // OpenAI profile output
  businessType      String?
  industry          String?
  geoScope          String?  // local, national, global
  brandName         String?
  brandVariants     Json?    // Array of brand name variants
  scoreTotal        Float    @default(0)
  scoreMax          Float    @default(100)
  createdAt         DateTime @default(now())
  
  scan              FootprintScan  @relation(fields: [scanId], references: [id], onDelete: Cascade)
  surfaceResults    SurfaceResult[]
  
  @@index([scanId])
  @@index([domainNormalized])
}

model SurfaceResult {
  id              String   @id @default(cuid())
  domainScanId    String
  category        String   // owned, search, social, trust, authority
  surfaceKey      String   // WEBSITE, LINKEDIN, YOUTUBE, etc.
  label           String   // Human-readable name
  status          String   // present, partial, absent, unknown
  confidence      Float?
  weight          Float    @default(1)
  relevance       String?  // high, medium, low
  pointsAwarded   Float    @default(0)
  pointsMax       Float
  source          String?  // direct, dataforseo, openai, crawl
  method          String?  // Description of how it was checked
  tooltipWhy      String?  @db.Text
  tooltipHow      String?  @db.Text
  tooltipAction   String?  @db.Text
  evidenceJson    Json?    // Array of evidence items
  queriesUsedJson Json?    // Queries used for this surface
  createdAt       DateTime @default(now())
  
  domainScan      DomainScan @relation(fields: [domainScanId], references: [id], onDelete: Cascade)
  
  @@index([domainScanId])
  @@index([surfaceKey])
}

// ============================================================================
// FOOTPRINT SURFACE REGISTRY (NORMALIZED)
// Separate catalog from versioned scanning rules
// ============================================================================

// A) FootprintSurface - CATALOG: what the surface is
model FootprintSurface {
  id                     String   @id @default(cuid())
  surfaceKey             String   @unique // GOOGLE_ORGANIC_BRAND, LINKEDIN, etc.
  label                  String   // Display name
  category               String   // owned, search, social, video, trust, authority, marketplace, community, technical, aeo, eeat_entity, performance_security
  importanceTier         String   // CRITICAL, HIGH, MEDIUM, LOW
  basePoints             Int      @default(10) // 0-30
  defaultRelevanceWeight Float    @default(1)  // 0..1
  enabled                Boolean  @default(true)
  tooltipTemplates       Json?    // { why, how, action } with status variants
  notes                  String?  @db.Text
  
  // Historical metadata
  launchYear             Int?     // Year this surface became available (e.g., 2012)
  technicalName          String?  // Original/technical name when released
  businessImpact         Json?    // { impactLevel, absenceImpact, partialImpact }
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  
  rules                  FootprintSurfaceRule[]

  @@index([category])
  @@index([importanceTier])
  @@index([enabled])
  @@map("footprint_surfaces")
}

// B) FootprintSurfaceRule - RULES: how to scan this surface (VERSIONED)
model FootprintSurfaceRule {
  id                     String   @id @default(cuid())
  surfaceId              String
  ruleVersion            Int      @default(1)
  isActive               Boolean  @default(true)
  
  // From JSON registry:
  sourceType             String   // WEBSITE_CRAWL, DATAFORSEO_SERP, DATAFORSEO_AUTOCOMPLETE, DNS_LOOKUP, MANUAL_REVIEW, GSC_API, BING_WMT_API, PAGESPEED_API
  searchEngine           String?  // google, bing, etc.
  queryTemplates         Json     @default("[]") // Array of query strings
  maxQueries             Int      @default(2)
  confirmationArtifact   String   @db.Text // What confirms presence
  presenceRules          Json?    // Rules for Present/Partial/Absent/Unknown
  officialnessRules      Json?    // Rules to decide official vs unverified
  officialnessRequired   Boolean  @default(true)
  evidenceFields         Json?    // Which fields to store
  
  // From CSV methods:
  checkMode              String?  // crawl_url, crawl_site, dns_lookup, requires_api_or_manual, etc.
  crawlOnlyFeasible      String?  // YES, PARTIAL, NO
  canonicalInputNeeded   String?  // domain, handle, qid, etc.
  discoveryApproach      String?  // prefer_entity_profile_url, entity_profile_or_schema_sameAs, etc.
  presenceLogic          String?  @db.Text // How to determine presence
  partialLogic           String?  @db.Text // What counts as partial
  evidenceProvider       String?  // CRAWL, DNS, SERP_PROVIDER, SUGGEST_PROVIDER, OWNER_API, MANUAL
  dataforseoRecommended  Boolean  @default(false)
  dataforseoEndpoint     String?  // DFS_SERP, DFS_AUTOCOMPLETE
  recommendedEvidenceArtifact String? @db.Text
  crawlFallbackIfNoDFS   String?  @db.Text
  metricsPossible        String?  @db.Text
  lastUpdatedExtraction  String?  @db.Text
  ruleNotes              String?  @db.Text
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  
  surface                FootprintSurface @relation(fields: [surfaceId], references: [id], onDelete: Cascade)
  overrides              FootprintSurfaceRuleOverride[]
  playbook               FootprintSurfaceManualPlaybook?

  @@unique([surfaceId, ruleVersion])
  @@index([surfaceId])
  @@index([isActive])
  @@index([sourceType])
  @@map("footprint_surface_rules")
}

// C) FootprintSurfaceRuleOverride - Geo/Industry multipliers
model FootprintSurfaceRuleOverride {
  id            String   @id @default(cuid())
  surfaceRuleId String
  overrideType  String   // "geo" or "industry"
  overrideKey   String   // e.g., "india", "global", "export", "b2b_manufacturing"
  multiplier    Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  rule          FootprintSurfaceRule @relation(fields: [surfaceRuleId], references: [id], onDelete: Cascade)

  @@index([surfaceRuleId])
  @@map("footprint_surface_rule_overrides")
}

// D) FootprintSurfaceManualPlaybook - Manual instructions + evidence capture
model FootprintSurfaceManualPlaybook {
  id                   String   @id @default(cuid())
  surfaceRuleId        String   @unique
  instructionsMarkdown String   @db.Text
  requiredEvidence     Json?    // { fields: [{name,type,required}], uploadsAllowed, screenshotRequired }
  validationChecklist  Json?    // Array of checklist items
  exampleQueries       Json?    // Array of strings
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  rule                 FootprintSurfaceRule @relation(fields: [surfaceRuleId], references: [id], onDelete: Cascade)

  @@map("footprint_surface_manual_playbooks")
}

// LEGACY: Keep old model for migration compatibility (will be removed later)
model FootprintSurfaceRegistry {
  id                     String   @id @default(cuid())
  surfaceKey             String   @unique
  label                  String
  category               String
  importanceTier         String
  basePoints             Int      @default(10)
  defaultRelevanceWeight Float    @default(1)
  sourceType             String
  searchEngine           String?
  queryTemplates         Json
  maxQueries             Int      @default(2)
  confirmationArtifact   String   @db.Text
  presenceRules          Json?
  officialnessRules      Json?
  officialnessRequired   Boolean  @default(true)
  evidenceFields         Json?
  tooltipTemplates       Json?
  enabled                Boolean  @default(true)
  notes                  String?  @db.Text
  industryOverrides      Json?
  geoOverrides           Json?
  launchYear             Int?
  technicalName          String?
  businessImpact         Json?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([category])
  @@index([importanceTier])
  @@index([enabled])
  @@index([sourceType])
}

// ============================================
// APP PROFILE - Global App Branding
// ============================================

model AppProfile {
  id          String   @id @default(cuid())
  key         String   @unique @default("primary")  // e.g., "primary"
  
  // Branding
  appName     String   @default("Keyword Ninja")
  tagline     String?  // Short tagline
  punchline   String?  // Marketing punch line
  
  // SEO Meta
  metaTitle       String?
  metaDescription String? @db.Text
  
  // Custom Fields (JSON for flexibility)
  customFields Json?   // { fieldName: value, ... }
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  logos       AppLogo[]
}

model AppLogo {
  id          String   @id @default(cuid())
  profileId   String
  
  name        String   // e.g., "Primary Logo", "Dark Mode Logo"
  filename    String
  mimeType    String
  size        Int
  url         String   // Local path or CDN URL
  isPrimary   Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  profile     AppProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@index([profileId])
}

// ============================================================================
// DIGITAL FOOTPRINT SCAN - Scan execution and results
// ============================================================================

// A) DigitalFootprintScan - One scan execution per client
model DigitalFootprintScan {
  id          String    @id @default(cuid())
  clientId    String    // FK to Client (stored in JSON, not DB relation)
  clientName  String?   // Denormalized for easy display
  mode        String    @default("CRAWL_ONLY") // CRAWL_ONLY | CRAWL_PLUS_PROVIDER
  status      String    @default("RUNNING")    // RUNNING | COMPLETED | FAILED
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  
  // Summary stats (computed after completion)
  summary     Json?     // { counts: { present, partial, absent, ... }, score, criticalGaps: [] }
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  results     DigitalFootprintScanResult[]
  
  @@index([clientId])
  @@index([status])
  @@map("digital_footprint_scans")
}

// B) DigitalFootprintScanResult - Result for each surface in a scan
model DigitalFootprintScanResult {
  id            String    @id @default(cuid())
  scanId        String
  surfaceKey    String
  surfaceRuleId String?   // FK to FootprintSurfaceRule (active version used)
  surfaceLabel  String?   // Denormalized for display
  category      String?   // Denormalized for grouping
  importanceTier String?  // Denormalized for prioritization
  
  // Result status
  status        String    @default("PENDING") // PRESENT_CONFIRMED | PRESENT_PARTIAL | ABSENT | NEEDS_ENTITY_INPUT | MANUAL_REQUIRED | REQUIRES_PROVIDER | ERROR | SKIPPED | PENDING
  confidence    Int       @default(50) // 0-100
  
  // Evidence captured during scan
  evidence      Json?     // { final_url, http_status, redirect_chain, page_title, extracted_fields, html_hash, checked_at, ... }
  
  // Metrics (when available)
  metrics       Json?     // { sitemapCount, lastPostDate, reviewCount, followerCount, ... }
  
  // Timestamps
  checkedAt     DateTime  @default(now())
  lastUpdatedAt DateTime?
  
  // Error handling
  errorMessage  String?   @db.Text
  
  // Manual submission tracking
  submittedBy   String?   // User ID who submitted manual evidence
  submittedAt   DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  scan          DigitalFootprintScan @relation(fields: [scanId], references: [id], onDelete: Cascade)
  evidenceFiles DigitalFootprintEvidenceFile[]
  
  @@unique([scanId, surfaceKey])
  @@index([scanId])
  @@index([surfaceKey])
  @@index([status])
  @@map("digital_footprint_scan_results")
}

// C) DigitalFootprintEvidenceFile - Uploaded evidence files
model DigitalFootprintEvidenceFile {
  id           String   @id @default(cuid())
  scanResultId String
  fileUrl      String
  fileType     String   // screenshot, pdf, etc.
  fileName     String?
  fileSize     Int?
  uploadedBy   String?  // User ID
  createdAt    DateTime @default(now())
  
  scanResult   DigitalFootprintScanResult @relation(fields: [scanResultId], references: [id], onDelete: Cascade)
  
  @@index([scanResultId])
  @@map("digital_footprint_evidence_files")
}
